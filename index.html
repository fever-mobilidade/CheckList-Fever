<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Checklist Digital FEVER</title>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        :root { --fever-green: #00ffcc; --fever-black: #000; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 10px; background: #ececec; color: #333; }
        .container { max-width: 600px; margin: auto; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .header { text-align: center; background: var(--fever-black); color: #fff; padding: 25px; border-radius: 10px 10px 0 0; margin: -15px -15px 20px -15px; border-bottom: 5px solid var(--fever-green); }
        .header h1 { margin: 0; color: var(--fever-green); font-size: 26px; text-transform: uppercase; letter-spacing: 2px; }
        
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 13px; color: #555; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; transition: 0.3s; }
        input:focus { border-color: var(--fever-green); outline: none; }

        .status-box { padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 15px; border: 2px solid #ccc; }
        .status-gps-off { background: #fff3cd; color: #856404; }
        .status-gps-on { background: #d4edda; color: #155724; border-color: #c3e6cb; }

        .photo-item { background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px dashed #bbb; margin-bottom: 15px; text-align: center; }
        .photo-item label { margin-bottom: 10px; font-size: 14px; }
        .preview-img { width: 100%; max-height: 300px; border-radius: 6px; display: none; margin-top: 10px; border: 2px solid var(--fever-black); }

        canvas#signature-pad { border: 2px solid var(--fever-black); width: 100%; height: 200px; background: #fff; border-radius: 8px; touch-action: none; }
        
        button#btn-main { width: 100%; padding: 20px; background: var(--fever-black); color: var(--fever-green); border: none; font-weight: bold; font-size: 18px; cursor: pointer; border-radius: 8px; margin-top: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        button:disabled { background: #666; color: #ccc; cursor: not-allowed; }

        #loading { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; color: var(--fever-green); text-align: center; }
        .spinner { border: 6px solid #333; border-top: 6px solid var(--fever-green); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner"></div>
    <p style="font-size: 18px;">ENVIANDO AUDITORIA DIGITAL...<br>Nﾃ｣o feche o navegador.</p>
</div>

<div class="container">
    <div class="header">
        <h1>FEVER</h1>
        <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.8;">SISTEMA OFICIAL DE VISTORIA</p>
    </div>

    <form id="formFever">
        <div id="status-gps" class="status-box status-gps-off">
            桃 Localizaﾃｧﾃ｣o Necessﾃ｡ria para Validaﾃｧﾃ｣o
            <button type="button" onclick="ativarGPS()" id="btn-gps" style="display:block; width:100%; margin-top:10px; padding:10px; background:var(--fever-black); color:#fff; border-radius:5px; border:none; cursor:pointer;">HABILITAR LOCALIZAﾃﾃグ</button>
        </div>

        <label>Placa do veﾃｭculo *</label>
        <input type="text" id="placa" required placeholder="Ex: ABC1D23" oninput="this.value = this.value.toUpperCase()">

        <label>KM Atual *</label>
        <input type="number" id="km" required placeholder="00000">

        <label>Cliente / Empresa *</label>
        <input type="text" id="empresa" required>

        <h3>Vistoria Tﾃｩcnica</h3>
        <div id="corpoChecklist"></div>

        <h3>Evidﾃｪncias Fotogrﾃ｡ficas</h3>
        <p style="font-size: 11px; color: #777;">Toque nos botﾃｵes para tirar foto ou escolher da galeria.</p>
        <div id="gridFotos"></div>

        <h3>Assinatura do Responsﾃ｡vel *</h3>
        <canvas id="signature-pad"></canvas>
        <button type="button" onclick="pad.clear()" style="margin-top:8px; background:none; border:none; color:red; text-decoration:underline; cursor:pointer;">Limpar Assinatura</button>
        
        <button type="submit" id="btn-main">FINALIZAR E ENVIAR OFICIAL</button>
    </form>
</div>

<script>
    const fotos = {};
    const canvas = document.getElementById('signature-pad');
    const pad = new SignaturePad(canvas);
    let userLoc = "GPS Nﾃグ AUTORIZADO";
    let gpsAtivo = false;

    // Ajuste de DPI da Assinatura
    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        pad.clear();
    }
    window.addEventListener("resize", resizeCanvas);
    setTimeout(resizeCanvas, 500);

    // FUNﾃﾃグ GPS ROBUSTA (IOS E ANDROID)
    function ativarGPS() {
        if (!navigator.geolocation) {
            alert("Seu navegador nﾃ｣o suporta GPS.");
            return;
        }

        const options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };

        navigator.geolocation.getCurrentPosition(
            p => {
                userLoc = `https://www.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}`;
                gpsAtivo = true;
                const s = document.getElementById('status-gps');
                s.className = "status-box status-gps-on";
                s.innerHTML = "笨 LOCALIZAﾃﾃグ CAPTURADA COM SUCESSO";
            },
            e => {
                let msg = "Erro ao obter GPS.";
                if(e.code == 1) msg = "Acesso ao GPS Negado. Por favor, habilite nas configuraﾃｧﾃｵes do seu celular/navegador.";
                alert(msg);
            }, 
            options
        );
    }

    // Gerar Checklist
    const itens = ["Pintura/Lataria", "Pneus/Rodas", "Parabrisa/Luzes", "Kit Ferramentas", "Nﾃｭvel de Bateria", "Higienizaﾃｧﾃ｣o"];
    itens.forEach(it => {
        document.getElementById('corpoChecklist').innerHTML += `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee;">
                <span style="font-size:14px;">${it}</span>
                <div>
                    <input type="radio" name="${it}" value="OK" required style="width:20px;"> OK
                    <input type="radio" name="${it}" value="AVARIA" style="width:20px; margin-left:10px;"> AVARIA
                </div>
            </div>`;
    });

    // GERADOR DE FOTOS ROBUSTO
    const fLabels = ["Frente", "Lateral Direita", "Traseira", "Lateral Esquerda", "Painel/KM"];
    fLabels.forEach((l, i) => {
        document.getElementById('gridFotos').innerHTML += `
            <div class="photo-item">
                <label>${l}</label>
                <input type="file" accept="image/*" onchange="processarFoto(this, ${i+1})" required>
                <img id="v${i+1}" class="preview-img">
            </div>`;
    });

    function processarFoto(input, id) {
        if (!input.files || !input.files[0]) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const MAX_WIDTH = 1000;
                let width = img.width;
                let height = img.height;

                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);

                // Marca d'ﾃ｡gua de seguranﾃｧa na foto
                ctx.fillStyle = "rgba(255, 255, 255, 0.7)";
                ctx.fillRect(0, height - 25, width, 25);
                ctx.font = "bold 14px Arial";
                ctx.fillStyle = "black";
                ctx.fillText(`FEVER VISTORIA - ${new Date().toLocaleString()}`, 10, height - 8);

                const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                fotos['foto'+id] = dataUrl;
                const preview = document.getElementById('v'+id);
                preview.src = dataUrl;
                preview.style.display = 'block';
            }
            img.src = e.target.result;
        }
        reader.readAsDataURL(input.files[0]);
    }

    document.getElementById("formFever").onsubmit = async (e) => {
        e.preventDefault();
        
        if(pad.isEmpty()) return alert("Assinatura ﾃｩ obrigatﾃｳria!");
        if(!gpsAtivo) {
            if(!confirm("GPS nﾃ｣o capturado. Deseja prosseguir apenas com o selo de hora da assinatura?")) return;
        }

        document.getElementById("loading").style.display = "flex";
        document.getElementById("btn-main").disabled = true;

        const checklistFinal = {};
        itens.forEach(it => {
            checklistFinal[it] = document.querySelector(`input[name="${it}"]:checked`).value;
        });

        const payload = {
            placa: document.getElementById("placa").value,
            empresa: document.getElementById("empresa").value,
            km: document.getElementById("km").value,
            checklist: checklistFinal,
            ...fotos,
            assinatura: pad.toDataURL(),
            localizacao: userLoc,
            dataHora: new Date().toLocaleString("pt-BR")
        };

        try {
            // URL DO SEU GOOGLE APPS SCRIPT
            const URL = "https://script.google.com/macros/s/AKfycbxuhQ5Ynz4CbNSTf-zlfmQxd6Hwt_Wnd5hkT3bawPQmG1LdHclWZy4SpzzdMrrqZtul/exec";
            
            await fetch(URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify(payload)
            });

            alert("Vistoria enviada com sucesso!");
            location.reload();
        } catch (err) {
            alert("Erro ao enviar. Verifique sua internet.");
            document.getElementById("btn-main").disabled = false;
            document.getElementById("loading").style.display = "none";
        }
    };
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist FEVER Oficial</title>
    <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 15px; background: #f4f4f4; color: #333; }
        .container { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .header { text-align: center; background: #000; color: #fff; padding: 20px; border-radius: 8px 8px 0 0; margin: -20px -20px 20px -20px; border-bottom: 4px solid #00ffcc; }
        .header h1 { margin: 0; color: #00ffcc; letter-spacing: 2px; font-size: 30px; font-family: 'Oxanium', sans-serif; font-weight: 700; text-transform: uppercase;}
        #step-gps { text-align: center; padding: 40px 10px; }
        #step-form { display: none; }
        #success-screen { display: none; text-align: center; padding: 40px 10px; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        .check-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
        .check-table th, .check-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .photo-item { background: #f9f9f9; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; border: 1px solid #ddd; }
        .preview-img { width: 100%; height: auto; max-height: 250px; object-fit: contain; display: none; margin-top: 10px; border: 2px solid #000; border-radius: 4px; }
        canvas#signature-pad { border: 2px solid #000; width: 100%; height: 200px; background: #fff; border-radius: 4px; cursor: crosshair; touch-action: none; }
        .btn-main { width: 100%; padding: 18px; background: #000; color: #00ffcc; border: none; font-weight: bold; font-size: 18px; cursor: pointer; border-radius: 4px; margin-top: 20px; }
        .btn-gps { background: #00ffcc; color: #000; animation: pulse 2s infinite; }
        .btn-secondary { background: #444; color: #fff; margin-top: 10px; font-size: 14px; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); color: #00ffcc; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #00ffcc; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading"><div class="spinner"></div><p>ENVIANDO AUDITORIA...<br>Aguarde.</p></div>

<div class="container">
    <div class="header"><h1>FEVER</h1><p>O FUTURO √â ELETRIZANTE</p></div>

    <div id="step-gps">
        <h2>Localiza√ß√£o do Checklist</h2>
        <p>Clique abaixo para registrar o local exato.</p>
        <button type="button" id="btn-gps" class="btn-main btn-gps" onclick="pegarLocalizacao()">üìç REGISTRAR LOCALIZA√á√ÉO</button>
        <p id="status-gps" style="margin-top:15px; font-size:14px; font-weight: bold;"></p>
        <p id="precisao-viva" style="font-size:12px; color:#666;"></p>
    </div>

    <div id="step-form">
        <form id="formFever">
            <label>Placa do ve√≠culo *</label><input type="text" id="placa" required maxlength="8">
            <label>Chassi (8 √∫ltimos) *</label><input type="text" id="chassi" maxlength="8" required>
            <label>Modelo *</label>
            <select id="modeloVeiculo" required>
                <option value="" disabled selected>Selecione</option>
                <option value="NEXTEM FN1000 HIGH BOX">NEXTEM FN1000 HIGH BOX</option>
                <option value="NEXTEM FN1000 MEGA BOX">NEXTEM FN1000 MEGA BOX</option>
                <option value="RAP FR250 BOX">RAP FR250 BOX</option>
                <option value="RAP FR150 FRIGO">RAP FR150 FRIGO</option>
                <option value="RAP FR110 BOX">RAP FR110 BOX</option>
            </select>
            <label>KM Atual *</label><input type="number" id="km" required>
            <label>Empresa (Cliente) *</label><input type="text" id="empresa" required maxlength="50">
            <label>CNPJ Empresa *</label><input type="text" id="cnpj" oninput="maskCNPJ(this)" required maxlength="18">
            <label>Nome do Usu√°rio *</label><input type="text" id="cliente" required maxlength="30">
            <label>Telefone *</label><input type="tel" id="telefone" oninput="maskTel(this)" required maxlength="15">
            <label>Data *</label><input type="date" id="dataRecebimento" required>

            <h3>Checklist</h3>
            <table class="check-table">
                <thead><tr><th style="text-align:left">Item</th><th>Ok</th><th>N√£o Ok</th><th>N/A</th></tr></thead>
                <tbody id="corpoTabela"></tbody>
            </table>

            <label>Algum Dano constatado?</label>
            <select id="dano" onchange="document.getElementById('campoObs').style.display=(this.value=='Sim'?'block':'none')">
                <option value="N√£o">N√£o</option><option value="Sim">Sim</option>
            </select>
            <div id="campoObs" style="display:none;"><textarea id="desc" rows="3"></textarea></div>

            <h3>Fotos</h3><div id="gridFotos"></div>

            <h3>Assinatura *</h3>
            <canvas id="signature-pad"></canvas>
            <button type="button" onclick="pad.clear()" style="width:100%; padding:10px; margin-top:5px;">Limpar</button>
            <button type="submit" class="btn-main">FINALIZAR E ENVIAR</button>
        </form>
    </div>

    <div id="success-screen">
        <h1 style="font-size: 80px; color: #00ffcc; margin: 0;">‚úî</h1>
        <h2>Enviado com Sucesso!</h2>
        <button onclick="location.reload()" class="btn-main">NOVO CHECKLIST</button>
        <button onclick="fecharJanela()" class="btn-main btn-secondary">FECHAR EM <span id="timer">10</span>s</button>
    </div>
</div>

<script>
    let userLoc = "N√£o capturado";
    let watchId = null;
    const canvas = document.getElementById('signature-pad');
    let pad;
    const fotos = {};

    function pegarLocalizacao() {
        const status = document.getElementById('status-gps');
        const precisaoTxt = document.getElementById('precisao-viva');
        const btn = document.getElementById('btn-gps');
        
        btn.disabled = true;
        btn.innerText = "CALIBRANDO GPS...";
        status.innerText = "Buscando sat√©lites...";

        if (!navigator.geolocation) return alert("GPS n√£o suportado.");

        // For√ßa o GPS real e ignora o sinal de torre (Ajustado para o Aririu da Formiga)
        watchId = navigator.geolocation.watchPosition(
            (p) => {
                const acc = p.coords.accuracy;
                precisaoTxt.innerText = `Margem de erro: ${acc.toFixed(1)} metros`;

                // O SEGREDO: S√≥ aceita se a precis√£o for menor que 65 metros (Sat√©lite real)
                if (acc <= 65) {
                    userLoc = `Lat: ${p.coords.latitude} Lon: ${p.coords.longitude} (Exato: ${acc.toFixed(1)}m)`;
                    navigator.geolocation.clearWatch(watchId);
                    
                    document.getElementById('step-gps').style.display = 'none';
                    document.getElementById('step-form').style.display = 'block';
                    if (!pad) {
                        pad = new SignaturePad(canvas);
                        resizeCanvas();
                    }
                } else {
                    status.innerText = "Sinal de rede detectado. Aguardando sat√©lite...";
                    status.style.color = "orange";
                }
            },
            (e) => {
                alert("Erro: Ative o GPS em 'Alta Precis√£o' e permita o acesso.");
                btn.disabled = false;
                btn.innerText = "TENTAR NOVAMENTE";
            },
            { enableHighAccuracy: true, maximumAge: 0, timeout: 25000 }
        );
    }

    function fecharJanela() { window.close(); setTimeout(() => { window.location.href = "about:blank"; }, 500); }
    
    function iniciarTimer() {
        let seg = 10;
        const t = setInterval(() => {
            seg--;
            document.getElementById('timer').innerText = seg;
            if(seg <= 0) { clearInterval(t); fecharJanela(); }
        }, 1000);
    }

    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
    }

    function maskTel(i) { let v = i.value.replace(/\D/g, ""); v = v.replace(/^(\d{2})(\d)/g, "($1) $2"); v = v.replace(/(\d)(\d{4})$/, "$1-$2"); i.value = v; }
    function maskCNPJ(i) { let v = i.value.replace(/\D/g, ""); v = v.replace(/^(\d{2})(\d)/, "$1.$2"); v = v.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3"); v = v.replace(/\.(\d{3})(\d)/, ".$1/$2"); v = v.replace(/(\d{4})(\d)/, "$1-$2"); i.value = v; }

    const itens = ["Pintura e Lataria", "Pneus", "Rodas", "Parabrisa e palhetas", "Documenta√ß√£o", "Chave do veiculo e ba√∫", "Kit de ferramentas", "Adesivos e Etiquetas", "Painel e Cabine", "Esta√ß√£o de Recarga", "Luzes externas", "Luzes internas", "Ar-condicionado", "Vidros e travas el√©tricas", "Kit Reparo do Pneu", "Central Multimidia"];
    itens.forEach(it => { document.getElementById('corpoTabela').innerHTML += `<tr><td style="text-align:left">${it}</td><td><input type="radio" name="${it}" value="Ok" required></td><td><input type="radio" name="${it}" value="N√£o Ok"></td><td><input type="radio" name="${it}" value="N/A"></td></tr>`; });

    const fLabels = ["Foto de Frente", "Foto Lateral Direita (motorista)", "Foto Traseira", "Foto Lateral Esquerda (passageiro)", "Foto da Placa", "Foto do Chassi", "Foto do Painel/KM"];
    fLabels.forEach((l, i) => { 
        document.getElementById('gridFotos').innerHTML += `<div class="photo-item"><label>${l}</label><input type="file" accept="image/*" capture="camera" onchange="compactar(this, ${i+1})" required><img id="v${i+1}" class="preview-img"></div>`; 
    });

    function compactar(input, id) {
        if (!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const cv = document.createElement('canvas');
                const max = 1000; let w = img.width, h = img.height;
                if (w > max) { h *= max / w; w = max; }
                cv.width = w; cv.height = h;
                cv.getContext('2d').drawImage(img, 0, 0, w, h);
                const b64 = cv.toDataURL('image/jpeg', 0.7);
                fotos['foto'+id] = b64;
                const preview = document.getElementById('v'+id);
                preview.src = b64; preview.style.display = 'block';
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }

    document.getElementById("formFever").onsubmit = async (e) => {
        e.preventDefault();
        if(pad.isEmpty()) return alert("Assinatura obrigat√≥ria!");
        document.getElementById("loading").style.display = "flex";
        
        const checks = {};
        itens.forEach(it => { const el = document.querySelector(`input[name="${it}"]:checked`); checks[it] = el ? el.value : "N/A"; });
        
        const payload = { ...fotos, checklistItems: checks, placa: document.getElementById("placa").value, chassi: document.getElementById("chassi").value, modelo: document.getElementById("modeloVeiculo").value, km: document.getElementById("km").value, empresa: document.getElementById("empresa").value, cnpj: document.getElementById("cnpj").value, cliente: document.getElementById("cliente").value, telefone: document.getElementById("telefone").value, dataRecebimento: document.getElementById("dataRecebimento").value, dano: document.getElementById("dano").value, desc: document.getElementById("desc").value || "Sem obs", assinatura: pad.toDataURL(), localizacao: userLoc, timestamp: new Date().toLocaleString("pt-BR") };

        try {
            // URL DO SEU SCRIPT GOOGLE

            const scriptURL = "https://script.google.com/macros/s/AKfycbwdGyTpGrKqaJz0VxDODzcBQeL25XaAsTiDV0mn7MKCYT6-0QzBgqnAYDayD71cApH4/exec";

            await fetch(scriptURL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
            document.getElementById("loading").style.display = "none";
            document.getElementById("step-form").style.display = "none";
            document.getElementById("success-screen").style.display = "block";
            iniciarTimer();
        } catch (err) { 
            alert("Erro no envio."); 
            document.getElementById("loading").style.display = "none"; 
        }
    };
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist FEVER Oficial</title>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 15px; background: #f4f4f4; color: #333; }
        .container { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .header { text-align: center; background: #000; color: #fff; padding: 20px; border-radius: 8px 8px 0 0; margin: -20px -20px 20px -20px; border-bottom: 4px solid #00ffcc; }
        .header h1 { margin: 0; color: #00ffcc; letter-spacing: 2px; font-size: 28px; }
        
        /* Controle de Telas */
        #step-gps { text-align: center; padding: 40px 10px; }
        #step-form { display: none; }
        #success-screen { display: none; text-align: center; padding: 40px 10px; }

        label { display: block; margin-top: 15px; font-weight: bold; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        .check-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
        .check-table th, .check-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        
        .photo-item { background: #f9f9f9; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; border: 1px solid #ddd; }
        .preview-img { width: 100%; height: auto; max-height: 250px; object-fit: contain; display: none; margin-top: 10px; border: 2px solid #000; border-radius: 4px; }
        
        canvas#signature-pad { border: 2px solid #000; width: 100%; height: 200px; background: #fff; border-radius: 4px; cursor: crosshair; touch-action: none; }
        
        .btn-main { width: 100%; padding: 18px; background: #000; color: #00ffcc; border: none; font-weight: bold; font-size: 18px; cursor: pointer; border-radius: 4px; margin-top: 20px; text-transform: uppercase; }
        .btn-gps { background: #00ffcc; color: #000; animation: pulse 2s infinite; }
        .btn-secondary { background: #444; color: #fff; margin-top: 10px; font-size: 14px; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }

        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); color: #00ffcc; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #00ffcc; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner"></div>
    <p>ENVIANDO AUDITORIA...<br>Aguarde.</p>
</div>

<div class="container">
    <div class="header">
        <h1>FEVER</h1>
        <p>O FUTURO √â ELETRIZANTE</p>
    </div>

    <div id="step-gps">
        <h2>Auditoria Digital</h2>
        <p>Para iniciar, precisamos calibrar sua localiza√ß√£o via sat√©lite.</p>
        <button type="button" id="btn-gps-trigger" class="btn-main btn-gps" onclick="ativarGPS()">üìç ATIVAR LOCALIZA√á√ÉO EXATA</button>
        <p id="msg-gps" style="margin-top:20px; color: #666; font-size: 14px; font-weight: bold;">Aguardando sinal...</p>
        <p id="precisao-info" style="font-size: 12px; color: #999;"></p>
    </div>

    <div id="step-form">
        <form id="formFever">
            <label>Placa do ve√≠culo *</label>
            <input type="text" id="placa" required placeholder="ABC-1234">
            
            <label>Chassi (8 √∫ltimos) *</label>
            <input type="text" id="chassi" maxlength="8" required>

            <label>Modelo do ve√≠culo*</label>
            <select id="modeloVeiculo" required>
                <option value="" disabled selected>Selecione</option>
                <option value="NEXTEM FN1000 HIGH BOX">NEXTEM FN1000 HIGH BOX</option>
                <option value="NEXTEM FN1000 MEGA BOX">NEXTEM FN1000 MEGA BOX</option>
                <option value="RAP FR250 BOX">RAP FR250 BOX</option>
                <option value="RAP FR150 FRIGO">RAP FR150 FRIGO</option>
                <option value="RAP FR110 BOX">RAP FR110 BOX</option>
            </select>

            <label>KM Atual *</label>
            <input type="number" id="km" required>

            <label>Empresa (Cliente) *</label>
            <input type="text" id="empresa" required>

            <label>CNPJ Empresa *</label>
            <input type="text" id="cnpj" oninput="maskCNPJ(this)" placeholder="00.000.000/0000-00" required>

            <label>Nome do Usu√°rio *</label>
            <input type="text" id="cliente" required>

            <label>Telefone *</label>
            <input type="tel" id="telefone" oninput="maskTel(this)" placeholder="(00) 00000-0000" required>

            <label>Data *</label>
            <input type="date" id="dataRecebimento" required>

            <h3>Checklist</h3>
            <table class="check-table">
                <thead><tr><th style="text-align:left">Item</th><th>Ok</th><th>N√£o Ok</th><th>N/A</th></tr></thead>
                <tbody id="corpoTabela"></tbody>
            </table>

            <label>Dano constatado?</label>
            <select id="dano" onchange="document.getElementById('campoObs').style.display=(this.value=='Sim'?'block':'none')">
                <option value="N√£o">N√£o</option>
                <option value="Sim">Sim</option>
            </select>
            <div id="campoObs" style="display:none;"><textarea id="desc" rows="3" placeholder="Descreva os danos..."></textarea></div>

            <h3>Fotos Obrigat√≥rias</h3>
            <div id="gridFotos"></div>

            <h3>Assinatura Digital *</h3>
            <canvas id="signature-pad"></canvas>
            <button type="button" onclick="pad.clear()" style="width:100%; padding:10px; margin-top:5px;">Limpar</button>
            
            <button type="submit" class="btn-main">FINALIZAR E ENVIAR</button>
        </form>
    </div>

    <div id="success-screen">
        <h1 style="font-size: 80px; color: #00ffcc; margin: 0;">‚úî</h1>
        <h2>Enviado com Sucesso!</h2>
        <p>A auditoria foi registrada.</p>
        
        <button onclick="location.reload()" class="btn-main">NOVO CHECKLIST</button>
        
        <button onclick="fecharJanela()" class="btn-main btn-secondary" id="btn-fechar">
            FECHAR EM <span id="timer">10</span>s
        </button>
    </div>
</div>

<script>
    let userLoc = "";
    let watchId = null;
    let countdownTimer;
    const fotos = {};
    const canvas = document.getElementById('signature-pad');
    let pad;

    // --- L√ìGICA DE LOCALIZA√á√ÉO PRECISA ---
    function ativarGPS() {
        const msg = document.getElementById('msg-gps');
        const info = document.getElementById('precisao-info');
        const btn = document.getElementById('btn-gps-trigger');
        
        btn.disabled = true;
        btn.innerText = "BUSCANDO SAT√âLITE...";

        if (!navigator.geolocation) return alert("GPS n√£o suportado.");

        // For√ßa o GPS de hardware e ignora cache
        const options = { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 };

        watchId = navigator.geolocation.watchPosition(
            p => {
                const acc = p.coords.accuracy;
                info.innerText = `Precis√£o atual: ${acc.toFixed(0)} metros...`;

                // S√≥ libera o formul√°rio se a precis√£o for menor que 80 metros (garante a rua correta)
                if (acc < 80) {
                    navigator.geolocation.clearWatch(watchId);
                    userLoc = `Lat: ${p.coords.latitude} Lon: ${p.coords.longitude} (Precis√£o: ${acc.toFixed(1)}m)`;
                    
                    document.getElementById('step-gps').style.display = 'none';
                    document.getElementById('step-form').style.display = 'block';
                    initSignature();
                    window.scrollTo(0,0);
                } else {
                    msg.innerText = "Sinal fraco. Aguarde o ponto exato...";
                    msg.style.color = "orange";
                }
            },
            e => {
                alert("Erro: Ative o GPS em modo 'Alta Precis√£o' e permita o acesso no navegador.");
                btn.disabled = false;
                btn.innerText = "TENTAR NOVAMENTE";
            },
            options
        );
    }

    // --- L√ìGICA DE ASSINATURA ---
    function initSignature() {
        pad = new SignaturePad(canvas);
        resizeCanvas();
    }

    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        if(pad) pad.clear();
    }
    window.addEventListener("resize", resizeCanvas);

    // --- L√ìGICA DE FECHAMENTO AUTOM√ÅTICO ---
    function fecharJanela() {
        clearInterval(countdownTimer);
        window.close();
        setTimeout(() => { if (!window.closed) window.location.href = "about:blank"; }, 500);
    }

    function iniciarContagemRegressiva() {
        let seg = 10;
        const display = document.getElementById('timer');
        countdownTimer = setInterval(() => {
            seg--;
            display.innerText = seg;
            if (seg <= 0) fecharJanela();
        }, 1000);
    }

    // --- M√ÅSCARAS E COMPACTA√á√ÉO ---
    function maskTel(i) { let v = i.value.replace(/\D/g, ""); v = v.replace(/^(\d{2})(\d)/g, "($1) $2"); v = v.replace(/(\d)(\d{4})$/, "$1-$2"); i.value = v; }
    function maskCNPJ(i) { let v = i.value.replace(/\D/g, ""); v = v.replace(/^(\d{2})(\d)/, "$1.$2"); v = v.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3"); v = v.replace(/\.(\d{3})(\d)/, ".$1/$2"); v = v.replace(/(\d{4})(\d)/, "$1-$2"); i.value = v; }

    // Gerar Checklist
    const itens = ["Pintura e Lataria", "Pneus", "Rodas", "Parabrisa e palhetas", "Documenta√ß√£o", "Chave do veiculo", "Kit de ferramentas", "Adesivos e Etiquetas", "Painel e Cabine", "Esta√ß√£o de Recarga", "Luzes externas", "Luzes internas", "Ar-condicionado", "Vidros e travas el√©tricas", "Reparo do Pneu", "Central Multimidia"];
    itens.forEach(it => { 
        document.getElementById('corpoTabela').innerHTML += `<tr><td style="text-align:left">${it}</td><td><input type="radio" name="${it}" value="Ok" required></td><td><input type="radio" name="${it}" value="N√£o Ok"></td><td><input type="radio" name="${it}" value="N/A"></td></tr>`; 
    });

    // Gerar Fotos
    const fLabels = ["Foto Frente", "Foto Lat. Direita", "Foto Traseira", "Foto Lat. Esquerda", "Foto Placa", "Foto Chassi", "Foto Painel/KM"];
    fLabels.forEach((l, i) => { 
        document.getElementById('gridFotos').innerHTML += `<div class="photo-item"><label>${l}</label><input type="file" accept="image/*" capture="camera" onchange="compactar(this, ${i+1})" required><img id="v${i+1}" class="preview-img"></div>`; 
    });

    function compactar(input, id) {
        if (!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const cv = document.createElement('canvas');
                const max = 1000; let w = img.width, h = img.height;
                if (w > max) { h *= max / w; w = max; }
                cv.width = w; cv.height = h;
                cv.getContext('2d').drawImage(img, 0, 0, w, h);
                const b64 = cv.toDataURL('image/jpeg', 0.7);
                fotos['foto'+id] = b64;
                const preview = document.getElementById('v'+id);
                preview.src = b64; preview.style.display = 'block';
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }

    // --- ENVIO DO FORMUL√ÅRIO ---
    document.getElementById("formFever").onsubmit = async (e) => {
        e.preventDefault();
        if(pad.isEmpty()) return alert("Assinatura obrigat√≥ria!");
        document.getElementById("loading").style.display = "flex";

        const checks = {};
        itens.forEach(it => { 
            const el = document.querySelector(`input[name="${it}"]:checked`);
            checks[it] = el ? el.value : "N/A"; 
        });

        const payload = {
            ...fotos,
            checklistItems: checks,
            placa: document.getElementById("placa").value,
            chassi: document.getElementById("chassi").value,
            modelo: document.getElementById("modeloVeiculo").value,
            km: document.getElementById("km").value,
            empresa: document.getElementById("empresa").value,
            cnpj: document.getElementById("cnpj").value,
            cliente: document.getElementById("cliente").value,
            telefone: document.getElementById("telefone").value,
            dataRecebimento: document.getElementById("dataRecebimento").value,
            dano: document.getElementById("dano").value,
            desc: document.getElementById("desc").value || "Sem obs",
            assinatura: pad.toDataURL(),
            localizacao: userLoc,
            timestamp: new Date().toLocaleString("pt-BR")
        };

        try {
            const scriptURL = "https://script.google.com/macros/s/AKfycbxuhQ5Ynz4CbNSTf-zlfmQxd6Hwt_Wnd5hkT3bawPQmG1LdHclWZy4SpzzdMrrqZtul/exec";
            await fetch(scriptURL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
            
            document.getElementById("loading").style.display = "none";
            document.getElementById("step-form").style.display = "none";
            document.getElementById("success-screen").style.display = "block";
            
            iniciarContagemRegressiva();
            window.scrollTo(0,0);
        } catch (err) {
            alert("Erro no envio.");
            document.getElementById("loading").style.display = "none";
        }
    };
</script>
</body>
</html>
